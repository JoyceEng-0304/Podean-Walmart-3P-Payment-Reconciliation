<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Commerce Canal Report Processor</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap');
*{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#0A0E17;--surface:#111827;--surfaceAlt:#1A2233;--border:#1E293B;--accent:#22D3EE;--accentDim:rgba(34,211,238,0.12);--accentGlow:rgba(34,211,238,0.25);--green:#34D399;--greenDim:rgba(52,211,153,0.12);--red:#F87171;--redDim:rgba(248,113,113,0.12);--amber:#FBBF24;--text:#F1F5F9;--textMuted:#94A3B8;--textDim:#64748B;--white:#FFFFFF}
body{min-height:100vh;background:linear-gradient(145deg,var(--bg) 0%,#0F172A 50%,#0C1220 100%);font-family:'DM Sans','Segoe UI',sans-serif;color:var(--text);position:relative;overflow-x:hidden}
canvas#particles{position:fixed;inset:0;width:100%;height:100%;pointer-events:none;z-index:0}
.wrap{position:relative;z-index:1;max-width:960px;margin:0 auto;padding:40px 24px 60px}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:.4}50%{opacity:1}}
@keyframes slideIn{from{opacity:0;transform:translateX(-12px)}to{opacity:1;transform:translateX(0)}}
@keyframes spin{to{transform:rotate(360deg)}}
.header{text-align:center;margin-bottom:48px;animation:fadeUp .6s ease}
.badge{display:inline-flex;align-items:center;gap:10px;background:var(--accentDim);border:1px solid rgba(34,211,238,.2);border-radius:100px;padding:6px 16px;margin-bottom:16px;font-size:12px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:var(--accent)}
.badge-dot{width:6px;height:6px;border-radius:50%;background:var(--accent);animation:pulse 2s infinite}
h1{font-size:36px;font-weight:700;letter-spacing:-.02em;background:linear-gradient(135deg,var(--white),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px}
.subtitle{font-size:15px;color:var(--textMuted);max-width:480px;margin:0 auto}
.upload-zone{border:2px dashed var(--border);border-radius:16px;padding:64px 32px;text-align:center;cursor:pointer;background:rgba(17,24,39,.6);backdrop-filter:blur(12px);transition:all .3s;animation:fadeUp .5s ease .2s both}
.upload-zone.drag{border-color:var(--accent);background:var(--accentDim);box-shadow:0 0 40px var(--accentGlow)}
.upload-zone svg{margin-bottom:16px;opacity:.7;transition:opacity .3s}
.upload-zone.drag svg{opacity:1}
.upload-zone p.main{font-size:16px;font-weight:600;margin-bottom:6px}
.upload-zone p.sub{font-size:13px;color:var(--textDim)}
#fileInput{display:none}
.processing,.error-box{background:rgba(17,24,39,.8);backdrop-filter:blur(12px);border:1px solid var(--border);border-radius:16px;padding:48px 32px;text-align:center;animation:fadeUp .4s ease}
.error-box{border-color:rgba(248,113,113,.2);padding:32px;text-align:left}
.spinner{display:inline-block;width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:16px}
.results{animation:fadeUp .5s ease}
.success-bar{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px;background:rgba(17,24,39,.8);backdrop-filter:blur(12px);border:1px solid rgba(52,211,153,.2);border-radius:12px;padding:16px 20px;margin-bottom:24px}
.success-info{display:flex;align-items:center;gap:10px}
.success-title{font-size:14px;font-weight:600;color:var(--green)}
.success-detail{font-size:12px;color:var(--textDim)}
.btn-group{display:flex;gap:10px}
.btn-download{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg,var(--green),#10B981);color:#fff;border:none;border-radius:8px;padding:10px 20px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;box-shadow:0 4px 16px var(--greenDim)}
.btn-reset{background:var(--surfaceAlt);color:var(--textMuted);border:1px solid var(--border);border-radius:8px;padding:10px 16px;font-size:13px;font-weight:500;cursor:pointer;font-family:inherit}
.btn-retry{background:var(--redDim);color:var(--red);border:1px solid rgba(248,113,113,.27);border-radius:8px;padding:8px 20px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;margin-top:12px}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:24px}
.kpi{background:rgba(17,24,39,.8);backdrop-filter:blur(8px);border:1px solid var(--border);border-radius:12px;padding:20px}
.kpi-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--textDim);margin-bottom:8px}
.kpi-value{font-size:24px;font-weight:700;font-family:'JetBrains Mono',monospace}
.card{background:rgba(17,24,39,.8);backdrop-filter:blur(8px);border:1px solid var(--border);border-radius:12px;margin-bottom:24px;overflow:hidden}
.card-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.card-header h2{font-size:15px;font-weight:600}
.card-header span{font-size:12px;color:var(--textDim)}
.card-body{padding:20px}
.fee-section{margin-bottom:24px}.fee-section:last-child{margin-bottom:0}
.fee-title{font-size:12px;font-weight:600;color:var(--textDim);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px}
table{width:100%;border-collapse:collapse;font-size:13px}
table.sku{font-size:12px;white-space:nowrap}
th{padding:10px 12px;text-align:left;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:var(--textDim);border-bottom:1px solid var(--border);background:var(--surfaceAlt)}
th.r{text-align:right}td.r{text-align:right}
td{padding:8px 12px}
td.mono{font-family:'JetBrains Mono',monospace;font-size:12px}
td.sku-id{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--accent)}
td.name{color:var(--textMuted);max-width:280px;overflow:hidden;text-overflow:ellipsis}
tr.alt td{background:rgba(26,34,51,.53)}
tr.sub-row td{border-top:2px solid rgba(34,211,238,.2)}
tr.sub-row td:first-child{font-weight:600}
tr.sub-row .val{font-weight:700;font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--accent)}
tfoot tr{border-top:2px solid rgba(34,211,238,.2);background:var(--surfaceAlt)}
tfoot td{padding:10px 12px;font-weight:700;font-family:'JetBrains Mono',monospace}
.recon-bar{padding:16px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:32px;font-size:13px;flex-wrap:wrap}
.recon-bar span.lbl{color:var(--textDim)}
.recon-bar span.val{font-weight:600;font-family:'JetBrains Mono',monospace}
.recon-highlight{background:var(--accentDim);border-radius:6px;padding:4px 12px;border:1px solid rgba(34,211,238,.2)}
.recon-highlight .val{font-weight:700;color:var(--accent)}
.c-green{color:var(--green)}.c-red{color:var(--red)}.c-amber{color:var(--amber)}.c-accent{color:var(--accent)}.c-dim{color:var(--textDim)}
.hidden{display:none}
</style>
</head>
<body>
<canvas id="particles"></canvas>
<div class="wrap">
  <div class="header">
    <div class="badge"><span class="badge-dot"></span>Reconciliation Tool</div>
    <h1>Commerce Canal Report Processor</h1>
    <p class="subtitle">Upload a Walmart Marketplace reconciliation report to generate a clean, formatted Excel summary.</p>
  </div>
  <div id="uploadZone" class="upload-zone" onclick="document.getElementById('fileInput').click()">
    <svg width="48" height="48" viewBox="0 0 48 48" fill="none"><rect x="8" y="28" width="32" height="14" rx="3" stroke="#22D3EE" stroke-width="2"/><path d="M24 6L24 28" stroke="#22D3EE" stroke-width="2" stroke-linecap="round"/><path d="M16 14L24 6L32 14" stroke="#22D3EE" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="34" cy="35" r="2" fill="#22D3EE"/></svg>
    <p class="main">Drop your reconciliation report here</p>
    <p class="sub">or click to browse — supports .xlsx and .xls files</p>
    <input type="file" id="fileInput" accept=".xlsx,.xls">
  </div>
  <div id="processingZone" class="processing hidden"><div class="spinner"></div><p style="font-size:15px;font-weight:500;color:var(--textMuted)">Processing <span id="processingName"></span>...</p></div>
  <div id="errorZone" class="error-box hidden">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px"><svg width="20" height="20" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="8" stroke="#F87171" stroke-width="1.5" fill="rgba(248,113,113,0.12)"/><path d="M10 6v5" stroke="#F87171" stroke-width="2" stroke-linecap="round"/><circle cx="10" cy="14" r="1" fill="#F87171"/></svg><span style="font-size:15px;font-weight:600;color:var(--red)">Processing Error</span></div>
    <p id="errorMsg" style="font-size:13px;color:var(--textMuted)"></p>
    <button class="btn-retry" onclick="resetApp()">Try Again</button>
  </div>
  <div id="resultsZone" class="results hidden"></div>
</div>
<script>
let appData=null,appFileName="";

// Particles
!function(){const c=document.getElementById("particles"),x=c.getContext("2d"),ps=[];function rs(){c.width=window.innerWidth;c.height=window.innerHeight}rs();window.addEventListener("resize",rs);for(let i=0;i<40;i++)ps.push({x:Math.random()*c.width,y:Math.random()*c.height,r:Math.random()*1.5+.5,vx:(Math.random()-.5)*.3,vy:(Math.random()-.5)*.3,o:Math.random()*.4+.1});!function d(){x.clearRect(0,0,c.width,c.height);ps.forEach(p=>{p.x+=p.vx;p.y+=p.vy;if(p.x<0)p.x=c.width;if(p.x>c.width)p.x=0;if(p.y<0)p.y=c.height;if(p.y>c.height)p.y=0;x.beginPath();x.arc(p.x,p.y,p.r,0,Math.PI*2);x.fillStyle=`rgba(34,211,238,${p.o})`;x.fill()});for(let i=0;i<ps.length;i++)for(let j=i+1;j<ps.length;j++){const d=Math.hypot(ps[i].x-ps[j].x,ps[i].y-ps[j].y);if(d<120){x.beginPath();x.moveTo(ps[i].x,ps[i].y);x.lineTo(ps[j].x,ps[j].y);x.strokeStyle=`rgba(34,211,238,${.06*(1-d/120)})`;x.stroke()}}requestAnimationFrame(d)}()}();

// Drag/drop
const uz=document.getElementById("uploadZone");
uz.addEventListener("dragover",e=>{e.preventDefault();uz.classList.add("drag")});
uz.addEventListener("dragleave",()=>uz.classList.remove("drag"));
uz.addEventListener("drop",e=>{e.preventDefault();uz.classList.remove("drag");if(e.dataTransfer.files[0])handleFile(e.dataTransfer.files[0])});
document.getElementById("fileInput").addEventListener("change",e=>{if(e.target.files[0])handleFile(e.target.files[0])});

function fd(v){if(!v)return"";if(typeof v==="number")return new Date((v-25569)*864e5).toISOString().slice(0,10);return String(v).slice(0,10)}
function fmt$(v){if(v===0)return"-";const n=v<0,s="$"+Math.abs(v).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",");return n?`(${s})`:s}
function show(id){["uploadZone","processingZone","errorZone","resultsZone"].forEach(z=>document.getElementById(z).classList.toggle("hidden",z!==id))}

function parseReconciliation(wb){
  const raw=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1,defval:null});
  if(!raw.length)throw new Error("Empty spreadsheet");
  const cm={};raw[0].forEach((h,i)=>{if(h)cm[String(h).trim()]=i});
  const req=["Partner Item Id","Amount","Amount Type","Transaction Type","Transaction Description","Ship Qty","Partner Item Name"];
  const miss=req.filter(r=>cm[r]===undefined);if(miss.length)throw new Error("Missing columns: "+miss.join(", "));
  const ci=n=>cm[n];let tp=raw[2]?.[ci("Total Payable")]||null;
  const ps=raw[2]?.[ci("Period Start Date")]||null,pe=raw[2]?.[ci("Period End Date")]||null;
  const fo=[],sr=[];
  for(let r=1;r<raw.length;r++){const row=raw[r],amt=parseFloat(row[ci("Amount")]);if(isNaN(amt))continue;const sku=row[ci("Partner Item Id")],at=row[ci("Amount Type")]?String(row[ci("Amount Type")]).trim():null,tt=row[ci("Transaction Type")]?String(row[ci("Transaction Type")]).trim():null,td=row[ci("Transaction Description")]?String(row[ci("Transaction Description")]).trim():null,sq=parseFloat(row[ci("Ship Qty")])||0,nm=row[ci("Partner Item Name")]?String(row[ci("Partner Item Name")]).trim():"";if(!sku)fo.push({td,amt,at});else sr.push({sku:String(sku).trim(),amt,at,tt,td,sq,nm})}
  const af={};fo.forEach(({td,amt})=>{const k=td||"Other";af[k]=(af[k]||0)+amt});
  const of2={"WFS Fulfillment Fee":sr.filter(r=>r.td==="WFS Fulfillment fee").reduce((s,r)=>s+r.amt,0),"WFS Return Processing Fee":sr.filter(r=>r.td==="WFS Return Processing Fee").reduce((s,r)=>s+r.amt,0),"Commission on Product":sr.filter(r=>r.at==="Commission on Product").reduce((s,r)=>s+r.amt,0)};
  const ats=["Product Price","Commission on Product","Fee/Reimbursement","Product tax","Product tax withheld"];
  const skus=[...new Set(sr.map(r=>r.sku))].map(sku=>{const rows=sr.filter(r=>r.sku===sku),nm=rows.find(r=>r.nm)?.nm||"",us=rows.filter(r=>r.tt==="Sale"&&r.at==="Product Price").reduce((s,r)=>s+r.sq,0),ur=rows.filter(r=>r.tt==="Refund"&&r.at==="Product Price").length,am={};ats.forEach(a=>{am[a]=rows.filter(r=>r.at===a).reduce((s,r)=>s+r.amt,0)});return{sku,nm,us,ur,am,net:Object.values(am).reduce((s,v)=>s+v,0)}}).sort((a,b)=>b.us-a.us);
  const acT=Object.values(af).reduce((s,v)=>s+v,0),snT=skus.reduce((s,r)=>s+r.net,0);
  return{ps:fd(ps),pe:fd(pe),tp,af,acT,of:of2,skus,ats,snT,gt:snT+acT};
}

// ─── ExcelJS styled output ───
const MF='$#,##0.00;($#,##0.00);"-"';
const F={title:{name:'Arial',size:14,bold:true,color:{argb:'FF2F5496'}},sub:{name:'Arial',size:10,italic:true,color:{argb:'FF666666'}},sec:{name:'Arial',size:11,bold:true,color:{argb:'FF2F5496'}},th:{name:'Arial',size:11,bold:true,color:{argb:'FFFFFFFF'}},n:{name:'Arial',size:10},b:{name:'Arial',size:10,bold:true},dk:{name:'Arial',size:11,bold:true,color:{argb:'FFFFFFFF'}}};
const BG={th:{type:'pattern',pattern:'solid',fgColor:{argb:'FF2F5496'}},alt:{type:'pattern',pattern:'solid',fgColor:{argb:'FFF2F7FB'}},tot:{type:'pattern',pattern:'solid',fgColor:{argb:'FFD6E4F0'}},dk:{type:'pattern',pattern:'solid',fgColor:{argb:'FF2F5496'}}};
const BD={tot:{top:{style:'medium',color:{argb:'FF2F5496'}},bottom:{style:'double',color:{argb:'FF2F5496'}}}};

function sty(ws,r,c,font,fill,border,numFmt,align){
  const cell=ws.getCell(r,c);
  if(font)cell.font=font;if(fill)cell.fill=fill;if(border)cell.border=border;if(numFmt)cell.numFmt=numFmt;if(align)cell.alignment=align;
}
function thRow(ws,r,cols){cols.forEach((v,i)=>{const c=ws.getCell(r,i+1);c.value=v;c.font=F.th;c.fill=BG.th;c.alignment={horizontal:'center',wrapText:true}})}
function dataRow(ws,r,vals,styles,isAlt){
  vals.forEach((v,i)=>{const c=ws.getCell(r,i+1);c.value=v;c.font=styles[i]?.font||F.n;if(styles[i]?.numFmt)c.numFmt=styles[i].numFmt;if(isAlt)c.fill=BG.alt;if(styles[i]?.alignment)c.alignment=styles[i].alignment;});
}
function totRow(ws,r,vals,styles){
  vals.forEach((v,i)=>{const c=ws.getCell(r,i+1);c.value=v;c.font=styles[i]?.font||F.b;c.fill=BG.tot;c.border=BD.tot;if(styles[i]?.numFmt)c.numFmt=styles[i].numFmt;});
}
function dkRow(ws,r,vals,styles){
  vals.forEach((v,i)=>{const c=ws.getCell(r,i+1);c.value=v;c.font=F.dk;c.fill=BG.dk;if(styles[i]?.numFmt)c.numFmt=styles[i].numFmt;});
}

async function generateExcel(d){
  const wb=new ExcelJS.Workbook();
  const ae=Object.entries(d.af),oe=Object.entries(d.of);
  const at=d.acT,ot=Object.values(d.of).reduce((s,v)=>s+v,0);
  const gs=d.skus.reduce((s,r)=>s+r.am["Product Price"],0);
  const tc=d.skus.reduce((s,r)=>s+r.am["Product tax"],0);
  const tw=d.skus.reduce((s,r)=>s+r.am["Product tax withheld"],0);

  // ══ FEES SUMMARY ══
  const ws=wb.addWorksheet('Fees Summary');
  ws.getColumn(1).width=50;ws.getColumn(2).width=18;
  let r=1;
  ws.mergeCells(r,1,r,3);ws.getCell(r,1).value="Commerce Canal — Fee Summary";ws.getCell(r,1).font=F.title;r++;
  ws.mergeCells(r,1,r,3);ws.getCell(r,1).value=`Period: ${d.ps} to ${d.pe}`;ws.getCell(r,1).font=F.sub;r+=2;
  ws.getCell(r,1).value="Account-Level Fees (Not Tied to a Specific SKU)";ws.getCell(r,1).font=F.sec;r++;
  thRow(ws,r,["Fee Type","Total ($)"]);r++;
  const ads=r;
  ae.forEach(([k,v],i)=>{dataRow(ws,r,[k,v],[{},{numFmt:MF}],i%2===1);r++});
  const asr=r;
  totRow(ws,r,["Total Account-Level Fees",{formula:`SUM(B${ads}:B${r-1})`,result:at}],[{},{numFmt:MF}]);r+=2;
  ws.getCell(r,1).value="Order-Level Fees (Included in SKU Net Amounts)";ws.getCell(r,1).font=F.sec;r++;
  thRow(ws,r,["Fee Type","Total ($)"]);r++;
  const ods=r;
  oe.forEach(([k,v],i)=>{dataRow(ws,r,[k,v],[{},{numFmt:MF}],i%2===1);r++});
  const osr=r;
  totRow(ws,r,["Total Order-Level Fees",{formula:`SUM(B${ods}:B${r-1})`,result:ot}],[{},{numFmt:MF}]);r++;
  dkRow(ws,r,["TOTAL ALL FEES",{formula:`B${asr}+B${osr}`,result:at+ot}],[{},{numFmt:MF}]);r+=3;
  ws.getCell(r,1).value="Reconciliation to Total Payable";ws.getCell(r,1).font=F.sec;r++;
  const rcs=r;
  [["Gross Product Sales",gs],["Product Tax Collected",tc],["Product Tax Withheld",tw],["Order-Level Fees (Commission + Fulfillment + Returns)",ot]].forEach(([l,v],i)=>{dataRow(ws,r,[l,v],[{},{numFmt:MF}],i%2===1);r++});
  const nsr=r;
  totRow(ws,r,["Net SKU Total",{formula:`SUM(B${rcs}:B${r-1})`,result:d.snT}],[{},{numFmt:MF}]);r++;
  const arr=r;
  dataRow(ws,r,["Account-Level Fees",{formula:`B${asr}`,result:at}],[{},{numFmt:MF}],false);r+=2;
  const pr=r;
  dkRow(ws,r,["TOTAL PAYABLE",{formula:`B${nsr}+B${arr}`,result:d.gt}],[{},{numFmt:MF}]);r++;
  const er=r;
  dataRow(ws,r,["Expected (per report)",d.tp],[{},{numFmt:MF}],false);r++;
  ws.getCell(r,1).value="Variance";ws.getCell(r,1).font=F.b;
  ws.getCell(r,2).value={formula:`B${pr}-B${er}`,result:Math.round((d.gt-d.tp)*100)/100};ws.getCell(r,2).font=F.b;ws.getCell(r,2).numFmt=MF;

  // ══ SKU SUMMARY ══
  const ws2=wb.addWorksheet('SKU Summary');
  const at2=d.ats,hd=["SKU","Product Name","Units Sold","Units Returned",...at2,"Net Amount"],nc=hd.length;
  ws2.getColumn(1).width=22;ws2.getColumn(2).width=55;ws2.getColumn(3).width=12;ws2.getColumn(4).width=14;
  for(let j=0;j<at2.length;j++)ws2.getColumn(5+j).width=22;
  ws2.getColumn(nc).width=15;
  r=1;
  ws2.mergeCells(r,1,r,nc);ws2.getCell(r,1).value="Commerce Canal — SKU Summary";ws2.getCell(r,1).font=F.title;r++;
  ws2.mergeCells(r,1,r,nc);ws2.getCell(r,1).value=`Period: ${d.ps} to ${d.pe}`;ws2.getCell(r,1).font=F.sub;r+=2;
  thRow(ws2,r,hd);r++;
  ws2.views=[{state:'frozen',ySplit:r-1}];
  const ds=r;
  d.skus.forEach((sk,i)=>{
    const vals=[sk.sku,sk.nm,sk.us,sk.ur,...at2.map(t=>sk.am[t]||0),{formula:`SUM(E${r}:I${r})`,result:sk.net}];
    const stys=[{},{},{},{},  ...at2.map(()=>({numFmt:MF})),{numFmt:MF}];
    dataRow(ws2,r,vals,stys,i%2===1);r++;
  });
  const de=r-1,tr2=r;
  const tus=d.skus.reduce((s,x)=>s+x.us,0),tur=d.skus.reduce((s,x)=>s+x.ur,0);
  const totVals=["TOTALS","",...[{formula:`SUM(C${ds}:C${de})`,result:tus},{formula:`SUM(D${ds}:D${de})`,result:tur},...at2.map((t,j)=>{const col=String.fromCharCode(69+j);return{formula:`SUM(${col}${ds}:${col}${de})`,result:d.skus.reduce((s,x)=>s+(x.am[t]||0),0)}}),{formula:`SUM(${String.fromCharCode(64+nc)}${ds}:${String.fromCharCode(64+nc)}${de})`,result:d.snT}]];
  const totStys=["TOTALS","",{},{},  ...at2.map(()=>({numFmt:MF})),{numFmt:MF}].map(s=>typeof s==='string'?{}:s);
  totRow(ws2,r,totVals,totStys);r+=2;
  const nsr2=r;
  ws2.getCell(r,1).value="Net SKU Total";ws2.getCell(r,1).font=F.b;
  const ncl=String.fromCharCode(64+nc);
  ws2.getCell(r,2).value={formula:`${ncl}${tr2}`,result:d.snT};ws2.getCell(r,2).font=F.b;ws2.getCell(r,2).numFmt=MF;r++;
  const afr2=r;
  ws2.getCell(r,1).value="Account-Level Fees (see Fees Summary)";ws2.getCell(r,1).font=F.n;
  ws2.getCell(r,2).value=d.acT;ws2.getCell(r,2).font=F.n;ws2.getCell(r,2).numFmt=MF;r++;
  dkRow(ws2,r,["TOTAL PAYABLE",{formula:`B${nsr2}+B${afr2}`,result:d.gt},...Array(nc-2).fill("")],[{},{numFmt:MF}]);

  const buf=await wb.xlsx.writeBuffer();
  const base64=buf.reduce((s,b)=>s+String.fromCharCode(b),'');
  const a=document.createElement('a');
  a.href='data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,'+btoa(base64);
  a.download=appFileName.replace(/\.[^.]+$/,"")+"_summary.xlsx";
  document.body.appendChild(a);a.click();document.body.removeChild(a);
}

function handleFile(f){
  appFileName=f.name;show("processingZone");document.getElementById("processingName").textContent=f.name;
  setTimeout(()=>{const reader=new FileReader();reader.onload=function(e){try{const wb=XLSX.read(new Uint8Array(e.target.result),{type:"array"});appData=parseReconciliation(wb);renderResults();show("resultsZone")}catch(err){document.getElementById("errorMsg").textContent=err.message;show("errorZone")}};reader.readAsArrayBuffer(f)},100);
}

function downloadExcel(){if(appData)generateExcel(appData)}
function resetApp(){appData=null;appFileName="";document.getElementById("fileInput").value="";document.getElementById("resultsZone").innerHTML="";show("uploadZone")}

function renderResults(){
  const d=appData;if(!d)return;const z=document.getElementById("resultsZone");
  const gs=d.skus.reduce((s,r)=>s+r.am["Product Price"],0),totalFees=d.acT+Object.values(d.of).reduce((s,v)=>s+v,0),tus=d.skus.reduce((s,r)=>s+r.us,0);
  z.innerHTML=`
  <div class="success-bar"><div class="success-info"><svg width="20" height="20" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="8" stroke="#34D399" stroke-width="1.5" fill="rgba(52,211,153,0.12)"/><path d="M6.5 10.5L9 13L14 7" stroke="#34D399" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><div><div class="success-title">Report processed successfully</div><div class="success-detail">${appFileName} — ${d.skus.length} SKUs, Period ${d.ps} to ${d.pe}</div></div></div>
  <div class="btn-group"><button class="btn-download" onclick="downloadExcel()"><svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M10 3v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M6 9l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M3 15v1a1 1 0 001 1h12a1 1 0 001-1v-1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg> Download Excel</button><button class="btn-reset" onclick="resetApp()">New File</button></div></div>
  <div class="kpi-grid">
    <div class="kpi" style="animation:slideIn .4s ease 0s both"><div class="kpi-label">Total Payable</div><div class="kpi-value c-accent">${fmt$(d.gt)}</div></div>
    <div class="kpi" style="animation:slideIn .4s ease .08s both"><div class="kpi-label">Gross Sales</div><div class="kpi-value c-green">${fmt$(gs)}</div></div>
    <div class="kpi" style="animation:slideIn .4s ease .16s both"><div class="kpi-label">Total Fees</div><div class="kpi-value c-red">${fmt$(totalFees)}</div></div>
    <div class="kpi" style="animation:slideIn .4s ease .24s both"><div class="kpi-label">Units Sold</div><div class="kpi-value c-amber">${tus}</div></div>
  </div>
  <div class="card"><div class="card-header"><h2>Fees Summary</h2></div><div class="card-body">${renderFeeSection("Account-Level Fees",Object.entries(d.af),d.acT)}${renderFeeSection("Order-Level Fees",Object.entries(d.of),Object.values(d.of).reduce((s,v)=>s+v,0))}</div></div>
  <div class="card"><div class="card-header"><h2>SKU Summary</h2><span>${d.skus.length} items</span></div>
  <div style="overflow-x:auto"><table class="sku"><thead><tr><th>SKU</th><th>Product Name</th><th class="r">Sold</th><th class="r">Returned</th><th class="r">Gross Sales</th><th class="r">Commission</th><th class="r">Fees</th><th class="r">Net</th></tr></thead>
  <tbody>${d.skus.map((r,i)=>`<tr class="${i%2===1?"alt":""}"><td class="sku-id">${r.sku}</td><td class="name">${r.nm}</td><td class="r mono">${r.us}</td><td class="r mono ${r.ur>0?"c-amber":"c-dim"}">${r.ur}</td><td class="r mono ${r.am["Product Price"]>=0?"c-green":"c-red"}">${fmt$(r.am["Product Price"])}</td><td class="r mono c-red">${fmt$(r.am["Commission on Product"])}</td><td class="r mono c-red">${fmt$(r.am["Fee/Reimbursement"])}</td><td class="r mono" style="font-weight:600;color:${r.net>=0?"var(--green)":"var(--red)"}">${fmt$(r.net)}</td></tr>`).join("")}</tbody>
  <tfoot><tr><td colspan="2" style="font-weight:700">TOTALS</td><td class="r">${tus}</td><td class="r c-amber">${d.skus.reduce((s,r)=>s+r.ur,0)}</td><td class="r c-green">${fmt$(gs)}</td><td class="r c-red">${fmt$(d.skus.reduce((s,r)=>s+r.am["Commission on Product"],0))}</td><td class="r c-red">${fmt$(d.skus.reduce((s,r)=>s+r.am["Fee/Reimbursement"],0))}</td><td class="r c-accent">${fmt$(d.snT)}</td></tr></tfoot></table></div>
  <div class="recon-bar"><div><span class="lbl">Net SKU Total: </span><span class="val">${fmt$(d.snT)}</span></div><div><span class="lbl">+ Acct Fees: </span><span class="val c-red">${fmt$(d.acT)}</span></div><div class="recon-highlight"><span class="lbl">Total Payable: </span><span class="val c-accent">${fmt$(d.gt)}</span></div></div></div>`;
}
function renderFeeSection(title,items,sub){return `<div class="fee-section"><div class="fee-title">${title}</div><table><tbody>${items.map(([k,v],i)=>`<tr class="${i%2===1?"alt":""}"><td style="color:var(--textMuted)">${k}</td><td class="r mono" style="color:${v<0?"var(--red)":"var(--green)"}">${fmt$(v)}</td></tr>`).join("")}<tr class="sub-row"><td>Subtotal</td><td class="r val">${fmt$(sub)}</td></tr></tbody></table></div>`}
</script>
</body>
</html>
